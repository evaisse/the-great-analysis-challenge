name: Test Chess Engines

on:
  pull_request:
    branches: [master]
  workflow_dispatch:
    inputs:
      test_all:
        description: 'Test all implementations (ignore changes)'
        required: false
        default: false
        type: boolean

env:
  DOCKER_BUILDKIT: 1

jobs:
  detect-changes:
    name: Detect Changed Implementations
    runs-on: ubuntu-latest
    outputs:
      changed-implementations: ${{ steps.changes.outputs.implementations }}
      has-changes: ${{ steps.changes.outputs.has-changes }}
      matrix: ${{ steps.generate-matrix.outputs.matrix }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Detect changed implementations
        id: changes
        run: |
          ./workflow detect-changes \
            "${{ github.event_name }}" \
            --test-all "${{ github.event.inputs.test_all }}" \
            --base-sha "${{ github.event.pull_request.base.sha }}" \
            --head-sha "${{ github.sha }}" \
            --before-sha "${{ github.event.before }}"

      - name: Generate dynamic matrix
        id: generate-matrix
        if: steps.changes.outputs.has-changes == 'true'
        run: |
          ./workflow generate-matrix \
            "${{ steps.changes.outputs.implementations }}"

  validation:
    name: Validate Implementation Structure
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.has-changes == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Run structure validation
        run: |
          echo "ğŸ” Running implementation structure validation..."
          python3 test/verify_implementations.py

  build-test:
    name: Build and Test Chess Engines
    runs-on: ubuntu-latest
    timeout-minutes: 45
    needs: [detect-changes, validation]
    if: needs.detect-changes.outputs.has-changes == 'true'
    
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
        
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Get test configuration
        id: config
        run: ./workflow get-test-config ${{ matrix.engine }}

      - name: Build Docker image
        run: |
          cd implementations/${{ matrix.engine }}
          echo "ğŸ—ï¸ Building ${{ matrix.engine }} chess engine..."
          docker build -t chess-${{ matrix.engine }} .
      
      - name: Verify analyze target
        run: ./workflow verify-make-target ${{ matrix.engine }} analyze

      - name: Verify test target
        run: ./workflow verify-make-target ${{ matrix.engine }} test

      - name: Run test suite (Advanced)
        run: python3 test/test_suite_runner.py --impl implementations/${{ matrix.engine }} --level advanced

      - name: Ensure workspace clean for ${{ matrix.engine }}
        run: |
          ENGINE=${{ matrix.engine }}
          if [[ -n "$(git status --porcelain implementations/${ENGINE})" ]]; then
            echo "Uncommitted changes detected after testing ${ENGINE}" >&2
            git status --short implementations/${ENGINE}
            exit 1
          fi

      - name: Cleanup
        if: always()
        run: ./workflow cleanup-docker ${{ matrix.engine }}

  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [detect-changes, validation, build-test]
    if: always()
    
    steps:
      - name: Test Results Summary
        run: |
          echo "ğŸ† Chess Engine Test Summary"
          echo "============================"
          echo ""
          
          CHANGED_IMPLEMENTATIONS="${{ needs.detect-changes.outputs.changed-implementations }}"
          HAS_CHANGES="${{ needs.detect-changes.outputs.has-changes }}"
          
          if [[ "$HAS_CHANGES" == "false" ]]; then
            echo "ğŸš« No implementation changes detected in this PR"
            echo "â­ï¸ All tests skipped - no changes to validate"
          elif [[ "$CHANGED_IMPLEMENTATIONS" == "all" ]]; then
            echo "âœ… All chess engine implementations tested"
            echo "ğŸ” Full validation suite completed"
          else
            echo "âœ… Changed implementations tested: $CHANGED_IMPLEMENTATIONS"
            echo "ğŸ¯ Selective testing completed for modified code only"
          fi
          
          echo ""
          echo "ğŸ”§ Convention-based testing features:"
          echo "- ğŸ“‹ chess.meta file configuration"
          echo "- ğŸ” Structure validation via Python script"
          echo "- ğŸ—ï¸ Docker build verification"
          echo "- ğŸ§ª Adaptive functionality testing"
          echo "- ğŸ“Š Dynamic discovery from directory structure"
          echo ""
          echo "âœ¨ Ready for merge when all checks pass!"
